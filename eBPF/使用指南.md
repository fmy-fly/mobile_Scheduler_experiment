# 项目使用指南

## 前置条件检查

您已经具备：
- ✅ Root 权限的手机
- ✅ 已安装 Termux

还需要确认：
- Android 版本 ≥ 12 (推荐，因为需要 GKI 内核的 BTF 支持)
- 电脑上已安装 ADB 工具

---

## 第一步：在 Termux 中搭建运行环境

### 1.1 安装必要的包

打开 Termux，执行以下命令：

```bash
# 更新包列表
pkg update

# 安装必要的工具
pkg install proot-distro python git

# 安装 Proot Ubuntu 环境（如果还没有）
proot-distro install ubuntu

# 进入 Ubuntu 环境
proot-distro login ubuntu
```

### 1.2 在 Ubuntu 环境中安装依赖

**进入 Ubuntu 后**，执行：

```bash
# 更新 apt
apt update
apt upgrade -y

# 安装 bpftrace 和 Python（如果还没有）
apt install -y bpftrace python3 python3-pip

# 验证安装
bpftrace --version
python3 --version
```

如果 bpftrace 无法通过 apt 安装，可能需要：
- 从源码编译，或
- 使用预编译的二进制文件

### 1.3 退出 Ubuntu，准备 BTF 文件

```bash
# 退出 Ubuntu 环境（回到 Termux）
exit
```

---

## 第二步：准备内核 BTF 文件（重要！）

**注意**：这一步必须在 Termux **原生环境**（非 Ubuntu Proot）中执行，因为需要直接访问 Android 内核文件系统。

### 2.1 获取 root 权限并检查 BTF 文件

在 Termux 中（**未进入 Ubuntu**），执行：

```bash
# 获取 root 权限
su

# 检查 BTF 文件是否存在
ls -l /sys/kernel/btf/vmlinux

# 如果文件存在，会显示类似：
# -r--r--r-- 1 root root 1234567 2024-01-01 12:00 /sys/kernel/btf/vmlinux
```

如果文件不存在，说明您的内核可能不支持 BTF，需要：
- 确认 Android 版本 ≥ 12
- 或使用其他方式获取 BTF 文件

### 2.2 复制 BTF 文件到中转目录

```bash
# 确保有中转目录
mkdir -p /sdcard/bpftrace_work

# 复制 BTF 文件（需要 root 权限）
cp /sys/kernel/btf/vmlinux /sdcard/bpftrace_work/vmlinux_btf

# 检查文件大小（通常几 MB 到几十 MB）
ls -lh /sdcard/bpftrace_work/vmlinux_btf
```

### 2.3 退出 root

```bash
exit
```

**重要提示**：BTF 文件只需要准备一次，除非您更新了系统内核或更换了设备。

---

## 第三步：从电脑推送项目文件到手机

### 3.1 连接手机到电脑

1. 用 USB 线连接手机到电脑
2. 在手机上允许 USB 调试授权
3. 确认 ADB 连接正常

在电脑上测试：

```cmd
adb devices
```

应该看到您的设备显示为 `device` 状态。

### 3.2 运行部署脚本

在 Windows 电脑上，进入项目目录，双击运行：

```
deploy.bat
```

或者打开 PowerShell/CMD，执行：

```cmd
cd D:\project\Paper\mobile_Scheduler_experiment\eBPF
deploy.bat
```

脚本会自动：
- ✅ 检查 ADB 连接
- ✅ 创建中转目录 `/sdcard/bpftrace_work`
- ✅ 推送 `capture.bt` 和 `live_analyzer.py` 到手机

看到"文件已上传到手机"的提示后，继续下一步。

---

## 第四步：在手机端迁移文件到工作目录

### 4.1 进入 Ubuntu 环境

在 Termux 中：

```bash
proot-distro login ubuntu
```

### 4.2 复制文件到工作目录

# 给 Termux 存储权限（必做）
在 Termux 里执行：
termux-setup-storage

**在 Ubuntu 环境中**，执行：

```bash
# 复制所有文件（包括 BTF 文件）到 /root/ 目录
cp /sdcard/bpftrace_work/* /root/

# 进入工作目录
cd /root/

# 查看文件列表，确认所有文件都在
ls -lh
```

您应该看到：
- `capture.bt` - eBPF 追踪脚本
- `live_analyzer.py` - Python 分析引擎
- `vmlinux_btf` - 内核 BTF 文件

### 4.3 设置执行权限（如果需要）

```bash
# 给 run 脚本添加执行权限（如果文件存在）
chmod +x run 2>/dev/null || true
```

---

## 第五步：运行监测系统

### 5.1 确保在正确目录

```bash
# 应该在 /root/ 目录
pwd
# 应该显示：/root

# 再次确认文件存在
ls -lh capture.bt live_analyzer.py vmlinux_btf
```

### 5.2 运行项目

有两种方式：

**方式 A：使用 run 脚本（推荐）**

```bash
# 如果 run 文件存在且有执行权限
./run
```

**方式 B：手动执行完整命令**

```bash
# 停止旧的 atrace
atrace --async_stop > /dev/null 2>&1

# 启动新的 atrace（追踪 Android 框架事件）
atrace --async_start -b 4096 -c am wm input view res

# 设置环境变量并运行
export BPFTRACE_BTF=/root/vmlinux_btf
export BPFTRACE_MAX_STRLEN=200
bpftrace capture.bt | python3 -u live_analyzer.py
```

### 5.3 验证运行状态

正常运行时，您应该看到：

```
Start
Tracing... Unrestricted Mode.
```

然后当您使用手机时，会看到实时输出：

```
[触摸] 在 com.tencent.mm 点击
[滑动] 正在 com.tencent.mm (开始滑动)
[冷启动] 新进程创建: com.tencent.mm
[页面切换] System -> com.tencent.mm
>>> [播放] 音频活跃
>>> [停止] 音频结束
[输入法] 键盘弹出
[输入法] 键盘收起
```

---

## 常见问题排查

### ❌ 问题 1：`bpftrace: BTF not found`

**原因**：BTF 文件路径不正确或文件不存在

**解决**：
```bash
# 检查 BTF 文件是否存在
ls -lh /root/vmlinux_btf

# 如果不存在，重新从 Android 复制
# 先退出 Ubuntu
exit

# 在 Termux 中（需要 root）
su
cp /sys/kernel/btf/vmlinux /sdcard/bpftrace_work/vmlinux_btf
exit

# 重新进入 Ubuntu 并复制
proot-distro login ubuntu
cp /sdcard/bpftrace_work/vmlinux_btf /root/
```

### ❌ 问题 2：`Permission denied` 或文件找不到

**原因**：文件权限问题或文件位置不对

**解决**：
```bash
# 确保文件在 /root/ 目录（不是 /sdcard/）
cd /root/
ls -lh

# 如果文件在 /sdcard/，重新复制
cp /sdcard/bpftrace_work/* /root/
```

### ❌ 问题 3：`bpftrace: command not found`

**原因**：bpftrace 未安装或不在 PATH

**解决**：
```bash
# 在 Ubuntu 环境中安装
apt update
apt install -y bpftrace

# 或检查是否已安装
which bpftrace
```

### ❌ 问题 4：没有任何事件输出

**可能原因**：
1. atrace 未正确启动
2. 应用未触发可监测的事件
3. bpftrace 无权限

**排查步骤**：
```bash
# 1. 检查是否有 root 权限（在 Termux 中，不在 Ubuntu 中）
# 退出 Ubuntu
exit

# 在 Termux 中获取 root
tsu

# 重新进入 Ubuntu（可能需要重新挂载）
proot-distro login ubuntu

# 2. 手动测试 bpftrace
bpftrace -e 'tracepoint:raw_syscalls:sys_enter { printf("syscall: %d\n", args->id); }'
# 按 Ctrl+C 停止，如果能看到输出说明 bpftrace 工作正常

# 3. 尝试启动一个应用或触摸屏幕，看是否有事件
```

### ❌ 问题 5：`atrace: command not found`

**原因**：atrace 是 Android 系统工具，不在 Ubuntu 环境中

**解决**：atrace 命令需要在 Android 原生环境中执行，但我们的脚本会在 Ubuntu 中通过某种方式调用它。如果确实找不到，可以：

```bash
# 检查 Android 系统路径
which atrace

# 或者直接指定完整路径
/system/bin/atrace --async_stop > /dev/null 2>&1
```

如果问题仍然存在，可能需要修改 `run` 脚本中的 atrace 路径。

---

## 更新项目文件

如果修改了 `capture.bt` 或 `live_analyzer.py`：

1. **只需重新执行第三步和第四步**：
   - 在电脑上运行 `deploy.bat` 推送新文件
   - 在手机 Ubuntu 中执行 `cp /sdcard/bpftrace_work/* /root/`

2. **BTF 文件无需重新准备**（除非更换设备或内核）

---

## 停止运行

要停止监测系统，按 `Ctrl+C`。

---

## 项目功能说明

本项目会实时监测并输出以下场景：

| 场景 | 触发条件 | 输出示例 |
|------|---------|---------|
| **应用冷启动** | 检测到 `bindApplication` 或 `activityStart` | `[冷启动] 新进程创建: com.tencent.mm` |
| **触摸事件** | 用户点击屏幕 | `[触摸] 在 com.tencent.mm 点击` |
| **滑动事件** | 用户快速连续触摸（滑动） | `[滑动] 正在 com.tencent.mm (开始滑动)` |
| **页面切换** | Activity 切换 | `[页面切换] 旧应用 -> 新应用` |
| **音频播放** | 检测到音频服务活跃 | `>>> [播放] 音频活跃` |
| **音频停止** | 音频停止播放（超时 1.5 秒） | `>>> [停止] 音频结束` |
| **输入法弹出** | 键盘显示 | `[输入法] 键盘弹出` |
| **输入法收起** | 键盘隐藏 | `[输入法] 键盘收起` |

---

## 下一步

项目正常运行后，您可以：
- 观察不同应用的使用场景
- 根据输出日志分析系统行为
- 对接上层分析系统或大模型

如有问题，请检查上述常见问题部分，或查看项目中的技术报告文档。


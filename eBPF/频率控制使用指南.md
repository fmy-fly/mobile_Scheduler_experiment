# eBPF频率控制使用指南

## 概述

本方案通过在设备本地运行eBPF监测系统，实时检测app启动事件并立即设置频率，**完全避免了WiFi远程连接的延迟问题**。

## 工作原理

1. **eBPF实时监测**：在设备本地运行bpftrace，实时捕获app启动事件（`activityStart`、`bindApplication`）
2. **本地频率设置**：检测到启动事件后，直接在设备上执行shell命令设置频率（不使用adb）
3. **时间段频率切换**：根据配置的时间段，自动在指定时间点切换频率

## 优势

- ✅ **零延迟**：在设备本地执行，无网络延迟
- ✅ **实时响应**：检测到`activityStart`后立即设置频率（通常在20ms内）
- ✅ **时间段支持**：支持多时间段频率配置，自动切换
- ✅ **无需WiFi**：完全在设备本地运行，不依赖网络连接

## 文件说明

- `live_analyzer_with_freq.py` - 支持频率控制的实时分析器
- `freq_config.py` - 频率配置文件（从batch_test.py提取）
- `run_with_freq` - 启动脚本（使用频率控制版本）

## 部署步骤

### 1. 部署文件到手机

在Windows电脑上运行：

```cmd
cd D:\project\Paper\mobile_Scheduler_experiment\eBPF
deploy.bat
```

这会自动推送以下文件到手机：
- `capture.bt`
- `live_analyzer.py`（原版）
- `live_analyzer_with_freq.py`（频率控制版）✨
- `freq_config.py`（频率配置）✨
- `run`

### 2. 在手机Ubuntu环境中复制文件

在Termux中：

```bash
# 进入Ubuntu环境
proot-distro login ubuntu

# 复制文件到工作目录
cp /sdcard/bpftrace_work/* /root/

# 进入工作目录
cd /root/

# 确认文件存在
ls -lh
```

### 3. 运行频率控制版本

**方式A：使用run_with_freq脚本（推荐）**

```bash
# 先复制run_with_freq到/root/
cp /sdcard/bpftrace_work/run_with_freq /root/
chmod +x run_with_freq

# 运行
./run_with_freq
```

**方式B：手动执行**

```bash
# 停止旧的atrace
atrace --async_stop > /dev/null 2>&1

# 启动新的atrace
atrace --async_start -b 4096 -c am wm input view res

# 设置环境变量并运行（使用频率控制版本）
export BPFTRACE_BTF=/root/vmlinux_btf
export BPFTRACE_MAX_STRLEN=200
bpftrace capture.bt | python3 -u live_analyzer_with_freq.py
```

## 输出示例

正常运行时，您会看到：

```
Start - 频率控制模式
Tracing... Unrestricted Mode.
[冷启动] 新进程创建: com.xingin.xhs
[频率控制] 找到配置: 小红书
[频率] policy0: 1950000 KHz (1950 MHz)
[频率] policy4: 2450000 KHz (2450 MHz)
[频率] policy7: 3015000 KHz (3015 MHz)
[频率] GPU: 850000 Hz (850 MHz)
[频率控制] 已启动，时间段数: 2
[频率切换] 时间段 2/2: 0.40s - 10.00s (当前: 0.401s)
[频率] policy0: 1696000 KHz (1696 MHz)
[频率] policy4: 2130000 KHz (2130 MHz)
[频率] policy7: 2687000 KHz (2687 MHz)
[频率] GPU: 521000 Hz (521 MHz)
```

## 配置说明

频率配置在 `freq_config.py` 中，格式与 `batch_test.py` 中的 `APP_FREQ_CONFIGS` 完全一致。

### 时间段频率配置示例

```python
"小红书": {
    "cpu_freq_settings": {
        "time_based": True,
        "periods": [
            {
                "start": 0.0,      # 启动后0秒开始
                "end": 0.4,        # 到0.4秒结束
                "cpu_freq": {
                    "0": 1950000,  # policy0: 1.95 GHz
                    "4": 2450000,  # policy4: 2.45 GHz
                    "7": 3015000   # policy7: 3.015 GHz
                },
                "gpu_freq": 850000  # GPU: 850 MHz
            },
            {
                "start": 0.4,      # 0.4秒后
                "end": 10.0,       # 到10秒结束
                "cpu_freq": {
                    "0": 1696000,  # 降低频率
                    "4": 2130000,
                    "7": 2687000
                },
                "gpu_freq": 521000
            }
        ]
    }
}
```

### 修改配置

如果需要修改某个app的频率配置：

1. 编辑 `freq_config.py`
2. 重新运行 `deploy.bat` 推送文件
3. 在手机Ubuntu中重新复制文件：`cp /sdcard/bpftrace_work/* /root/`
4. 重启监测系统

## 工作原理详解

### 1. 启动检测

系统通过eBPF捕获以下事件：
- `activityStart` - Activity启动（system_server写入）
- `bindApplication` - 应用绑定（app进程写入）

### 2. 频率设置时机

- **第一重触发**：检测到`activityStart`时立即设置初始频率（通常在app启动后20ms内）
- **第二重触发**：检测到`bindApplication`时确认应用身份并启动时间段监控

### 3. 时间段切换

- 启动后立即设置第一个时间段的频率
- 后台线程每10ms检查一次经过时间
- 当时间进入新的时间段时，自动切换频率

## 注意事项

1. **需要root权限**：频率设置需要root权限，确保设备已root
2. **BTF文件**：确保已准备好BTF文件（见原使用指南）
3. **Python环境**：确保Ubuntu环境中已安装Python3
4. **配置同步**：修改配置后需要重新部署文件

## 故障排查

### 问题1：频率设置失败

**现象**：看到 `[WARN] 设置CPU频率失败`

**解决**：
```bash
# 检查root权限
su
# 手动测试频率设置
echo 1950000 > /sys/devices/system/cpu/cpufreq/policy0/scaling_min_freq
# 如果失败，检查文件权限
ls -l /sys/devices/system/cpu/cpufreq/policy0/scaling_min_freq
```

### 问题2：找不到配置

**现象**：看到 `[频率控制] 未找到配置`

**解决**：
- 检查 `freq_config.py` 中是否包含该app的配置
- 确认包名匹配（通过 `get_package_name` 获取的完整包名）

### 问题3：时间段切换不准确

**现象**：频率切换时间点不对

**原因**：时间段切换基于Python的`time.time()`，与Perfetto trace的时间基准可能不一致

**解决**：这是正常现象，因为：
- eBPF系统的时间基准是Python脚本启动时间
- Perfetto trace的时间基准是系统启动时间
- 两者有差异是正常的，但频率设置仍然有效

## 性能对比

| 方案 | 延迟 | 可靠性 |
|------|------|--------|
| WiFi + adb shell | 300-700ms | 受网络影响 |
| **本地eBPF** | **<20ms** | **高** |

## 下一步

1. 运行监测系统并观察输出
2. 根据实际效果调整频率配置
3. 结合Perfetto trace验证频率设置效果

